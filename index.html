<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fabric.js Drawing with Template</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body { 
      text-align: center; 
      margin: 0; 
      padding: 0; 
      font-family: Arial, sans-serif;
      background-color: #FFFFFF;
    }
    canvas { 
      border: 1px solid #ccc; 
      margin-top: 20px; 
      display: block; 
      max-width: 100%;
      max-height: 80vh; /* Allow canvas to grow but not exceed 80% of the screen height */
      margin: 0 auto; /* Center the canvas horizontally */
    }
    button { 
      margin: 5px; 
      padding: 10px; 
      font-size: 14px; 
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    input[type="color"] {
      margin-top: 10px;
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h1>Gender? </h1>

  <div>
    <button onclick="addShape('rect')">Add Rectangle</button>
    <button onclick="addShape('circle')">Add Circle</button>
    <button onclick="enableDrawing()">Free Draw</button>
    <button onclick="addShape('line')">Add Line</button>
    <button onclick="addShape('triangle')">Add Triangle</button>
    <button onclick="deleteObject()">Delete Object</button>
    <button onclick="disableDrawing()">Select/Move</button>
    <button onclick="zoomIn()">Zoom In</button>
    <button onclick="zoomOut()">Zoom Out</button>
    <button onclick="saveImage()">Save as Image</button>

    <input type="color" id="colorPicker" value="#0000ff" onchange="updateDrawingColor()">
  </div>

  <canvas id="c"></canvas>

  <script>
    const canvas = new fabric.Canvas('c');
    let currentColor = '#0000ff';  // Default color is blue

    let pendingShapeType = null;  // New global variable at the top

function addShape(type) {
  pendingShapeType = type;  // Save the type, wait for a click
  setActiveTool(type);
  
}
///////pinch zoom start
const htmlCanvas = document.querySelector('canvas'); // Get the real <canvas> element
let initialDistance = null;
let initialZoom = canvas.getZoom();

function setActiveTool(toolName) {
      const activeToolDiv = document.getElementById('activeTool');
      activeToolDiv.textContent = 'Active Tool: ' + toolName;
    }

// Helper function to calculate distance between two fingers
function getDistance(touches) {
  const dx = touches[0].pageX - touches[1].pageX;
  const dy = touches[0].pageY - touches[1].pageY;
  return Math.sqrt(dx * dx + dy * dy);
}

// Listen for touchstart
htmlCanvas.addEventListener('touchstart', function(event) {
  if (event.touches.length === 2) {
    initialDistance = getDistance(event.touches);
    initialZoom = canvas.getZoom();
  }
});

// Listen for touchmove
htmlCanvas.addEventListener('touchmove', function(event) {
  if (event.touches.length === 2 && initialDistance) {
    event.preventDefault(); // Important! Prevent page zoom
    const newDistance = getDistance(event.touches);
    const zoomFactor = newDistance / initialDistance;
    canvas.zoomToPoint({ x: canvas.width / 2, y: canvas.height / 2 }, initialZoom * zoomFactor);
  }
}, { passive: false }); // passive: false lets you call preventDefault()

// Listen for touchend
htmlCanvas.addEventListener('touchend', function() {
  initialDistance = null;
});

/////////////// Pinch zoom end ///////////////
canvas.on('mouse:down', function(event) {
  if (!pendingShapeType) return;  // If no shape is pending, do nothing

  // Check if an object was clicked
  if (event.target) {
    // An object was clicked, select it
    canvas.setActiveObject(event.target);
    console.log('Clicked on an object:', event.target.type);
    return; // Don't add a new shape
  }

  // No object clicked, so we can add a new shape
  const pointer = canvas.getPointer(event.e);
  const left = pointer.x;
  const top = pointer.y;

  let shape;
  switch (pendingShapeType) {
    case 'rect':
      setActiveTool('Rectangle');
      shape = new fabric.Rect({
        left: left - 30,
        top: top - 35,
        fill: currentColor,
        width: 60,
        height: 70,
        angle: 0
      });
      break;
    case 'circle':
      setActiveTool('Circle');
      shape = new fabric.Circle({
        left: left - 30,
        top: top - 30,
        fill: currentColor,
        radius: 30
      });
      break;
    case 'line':
      setActiveTool('Line');
      shape = new fabric.Line([left, top, left, top + 200], {
        stroke: currentColor,
        strokeWidth: 8,
        selectable: true
      });
      break;
    case 'triangle':
      setActiveTool('Triangle');
      shape = new fabric.Triangle({
        width: 100,
        height: 100,
        left: left - 50,
        top: top - 50,
        fill: currentColor,
        selectable: true
      });
      break;
  }

  canvas.add(shape);
});


    // Function to resize the canvas based on the window size
    function resizeCanvas() {
      canvas.setWidth(window.innerWidth - 20);  // 20px for margin
      canvas.setHeight(window.innerHeight - 100); // Adjust height for header and buttons
      canvas.renderAll();
      createTemplate();  // Re-create the template when the canvas resizes
    }

    // Update the drawing color when the user picks a color
    function updateDrawingColor() {
  currentColor = document.getElementById('colorPicker').value;
  console.log('Current color selected:', currentColor);

  const selectedObject = canvas.getActiveObject();
  if (selectedObject) {
    if (selectedObject.type === 'line') {
      selectedObject.set('stroke', currentColor);
    } else if (selectedObject.type === 'text') {
      selectedObject.set('fill', currentColor);
    } else {
      selectedObject.set('fill', currentColor);
    }
    canvas.renderAll();
  }
}

    // Function to zoom in
    function zoomIn() {
      const zoom = canvas.getZoom();
      canvas.zoomToPoint({ x: canvas.width / 2, y: canvas.height / 2 }, zoom + 0.1);
    }

// Function to zoom out
    function zoomOut() {
      const zoom = canvas.getZoom();
      canvas.zoomToPoint({ x: canvas.width / 2, y: canvas.height / 2 }, zoom - 0.1);
    }
 
    // Enable free drawing mode and set the color
    function enableDrawing() {
      canvas.isDrawingMode = true;
      canvas.freeDrawingBrush.width = 5;
      canvas.freeDrawingBrush.color = currentColor;  // Set drawing color to the selected color
      pendingShapeType = null;  // Clear the pending shape
      setActiveTool('Free Draw');

    }

    // Disable free drawing mode
    function disableDrawing() {
      canvas.isDrawingMode = false;
      pendingShapeType = null;  // Clear the pending shape
      setActiveTool('Select/Move');
    }

    // Save the canvas as an image
    function saveImage() {
      const dataURL = canvas.toDataURL({
        format: 'png'
      });
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = 'my-drawing.png';
      link.click();
    }

    // Delete the selected object (turn it white and make it small)
    function deleteObject() {
      const selectedObject = canvas.getActiveObject();
      if (selectedObject) {
        selectedObject.set({ fill: 'white', stroke: 'white', width: 1, height: 1 });
        canvas.renderAll();
      }
    }

    // Create a "background" layer with axis lines and circle outlines
    function createTemplate() {
      // Recalculate the center of the canvas based on the current size
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      // Calculate the maximum possible radius for the circles
      const maxRadius = Math.min(canvas.width, canvas.height) / 2.2;

      // Remove any existing axis lines, circles, or text objects (misplaced or duplicates)
      canvas.getObjects().forEach(function(obj) {
        if (obj.selectable === false || obj.type === 'text' || obj.type === 'circle') {
          canvas.remove(obj); // Remove axis lines, text, and circles
        }
      });

      // Axis 1: Vertical line (center of the canvas) - stops at the max radius
      const axis1 = new fabric.Line([centerX, centerY, centerX, centerY - maxRadius], {
        stroke: '#000000',
        strokeWidth: 10,
        selectable: false,
        evented: false
      });

      // Axis 2: Bottom-left diagonal line - stops at the max radius
      const axis2 = new fabric.Line([centerX+5, centerY-2, centerX + maxRadius+5, centerY-2], {
        stroke: '#000000',
        strokeWidth: 10,
        selectable: false,
        evented: false
      });
     axis2.set({ angle: 30});

      // Axis 3: Bottom-right diagonal line - stops at the max radius
      const axis3 = new fabric.Line([centerX+5, centerY+8, centerX + maxRadius+5, centerY+8], {
        stroke: '#000000',
        strokeWidth: 10,
        selectable: false,
        evented: false
      });
      axis3.set({ angle: 150});
      // Add text to the template
      const label1 = new fabric.Text('3', {
        left: centerX -25,  // Adjust text to be centered horizontally
        top: centerY - maxRadius -25,   // Adjust text to be placed above the center
        fontSize: 24,
        fill: '#AAAAAA',
        selectable: true   // Make the text selectable to allow interaction
      });

      // Add text to the template
      const label2 = new fabric.Text('B', {
        left: centerX - maxRadius,  // Adjust text to be centered horizontally
        top: centerY + maxRadius/2,   // Adjust text to be placed above the center
        fontSize: 24,
        fill: '#AAAAAA',
        selectable: true   // Make the text selectable to allow interaction
      });

      // Add text to the template
      const label3 = new fabric.Text('G', {
        left: centerX + maxRadius,  // Adjust text to be centered horizontally
        top: centerY + maxRadius/2,   // Adjust text to be placed above the center
        fontSize: 24,
        fill: '#AAAAAA',
        selectable: true   // Make the text selectable to allow interaction
      });

      // Add center dot
      const centerDot = new fabric.Circle({
        left: centerX-2,  // Adjust the center of the circle to the center of the canvas
        top: centerY-4 ,  // Adjust the center of the circle to the center of the canvas
        radius: 7,
        fill: '#000000',
        selectable: false,  // Make it unselectable
      });

      // Add circle outlines radiating outward from the center
      const circle1 = new fabric.Circle({
        left: centerX - maxRadius,  // Position relative to center
        top: centerY - maxRadius,   // Position relative to center
        radius: maxRadius,
        stroke: '#DDDDDD',
        strokeWidth: 5,
        fill: 'transparent',
        selectable: false,
        evented: false
      });

      const circle2 = new fabric.Circle({
        left: centerX - maxRadius * 0.75,
        top: centerY - maxRadius * 0.75,
        radius: maxRadius * 0.75,
        stroke: '#DDDDDD',
        strokeWidth: 5,
        fill: 'transparent',
        selectable: false,
        evented: false
      });

      const circle3 = new fabric.Circle({
        left: centerX - maxRadius * 0.5,
        top: centerY - maxRadius * 0.5,
        radius: maxRadius * 0.5,
        stroke: '#DDDDDD',
        strokeWidth: 5,
        fill: 'transparent',
        selectable: false,
        evented: false
      });

      const circle4 = new fabric.Circle({
        left: centerX - maxRadius * 0.25,
        top: centerY - maxRadius * 0.25,
        radius: maxRadius * 0.25,
        stroke: '#DDDDDD',
        strokeWidth: 5,
        fill: 'transparent',
        selectable: false,
        evented: false
      });

      // Add the elements to the canvas
      canvas.add(circle1, circle2, circle3, circle4, axis1, axis2, axis3, label1, label2, label3, centerDot);
      canvas.sendToBack(circle1);
      canvas.sendToBack(circle2);
      canvas.sendToBack(circle3);
    }

    // Call the template creator immediately
    createTemplate();

    // Adjust canvas size when the window is resized
    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('keydown', function(event) {
    if (event.key === 'Delete' || event.key === 'Backspace') {
      deleteObject();
      }
    });

    // Initial resize
    resizeCanvas();
  </script>
  <div id="activeTool" style="margin-top: 10px; font-weight: bold;">Active Tool: None</div>


</body>
</html>
